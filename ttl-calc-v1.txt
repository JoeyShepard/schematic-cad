;Tests
;=====
;123 . NL 456 "Hello, World!" .s
;swap .s drop .s . .s
;END
;CHIP CHIP                              ;error - chip in chip not allowed
;CHIP NAME                              ;error - no name on stack
;CHIP 5 NAME                            ;error - wrong name type
;CHIP "FOO" NAME 1 DOWN 2 RIGHT END     ;repositioning
;CHIP "BAR" NAME 1 UP 2 LEFT END        ;repositioning
;CHIP END                               ;error - chip without name
;CHIP "A" NAME END CHIP "A" NAME END    ;error - chip already exists
;5 "num" def "abc" "str" def num str .s ;defining symbols
;123 "FoO" def fOo                      ;symbol names not case-sensitive
;40 4 "74HCTEST" SIZE                   ;auto-generated package name
;CHIP "FOO" NAME 
;"74HCTEST" MODEL END
;CHIP "FOO" NAME ""                     ;purposely blank package name
;"74xx" MODEL PKG END
;CHIP "FOO" NAME 2 DOWN 3 RIGHT END     ;cursor movement for next chip
;CHIP "BAR" NAME 2 DOWN 3 RIGHT END
;CHIP "FOO" NAME 1 X 2 Y END            ;chip placement
;CHIP "FOO" NAME 6 X 7 Y 
;10 width 5 height END                  ;size and shape attributes
;FoO.left foo.right 
;foo.top foo.bottom
;foo.width foo.height
;last.left last.right
;last.top last.bottom
;last.width last.height .s
;1 2 + 9 4 - 3 7 * 7 3 /                ;arithmetic
;255 128 32 rgb .$                      ;colors
;18 52 86 rgb
;dup chip-color
;dup wire-color
;dup border-color
;dup title-color
;dup subtitle-color
;dup bg-color
;    grid-color
;CHIP "FOO" NAME 5 COLOR 6 border-color
;7 title-color 8 subtitle-color END
;9 chip-color
;10 wire-color
;11 border-color
;12 title-color
;13 subtitle-color
;14 bg-color
;15 grid-color
;red green blue white black
;cyan magenta yellow 
;gray40 gray80 grayC0 .s$
;18 title-size                          ;fonts
;12 subtitle-size
;"monospace" font-name

;Setup
;=====
2   MARGIN
18  TITLE-SIZE
14  SUBTITLE-SIZE
14  LABEL-SIZE
"monospace" FONT-NAME
192 192 192 RGB TITLE-COLOR
160 160 160 RGB SUBTITLE-COLOR


;Constants
;=========
2 "SPACING" DEF
SPACING 3 2 / * "SPACING1.5" DEF
SPACING 2 * "SPACING2" DEF 
SPACING 4 * "L2-SPACING" DEF    ;enough vertical spacing for two wire labels


;Chip sizes
;==========
16 4 "74HC138" SIZE
16 4 "74HC193" SIZE
20 4 "74HC244" SIZE
20 4 "74HC574" SIZE
16 4 "74HC670" SIZE
28 6 "8K EEPROM" SIZE
28 6 "32K EEPROM" SIZE      ;ie AT28C256
28 6 "8K SRAM" SIZE

;Chip definitions
;================
CHIP
    "Carry Buffer"  NAME
    "74HC574"       MODEL
    17 RIGHT
    GREEN BORDER-COLOR
END

CHIP
    "ALU Latch" NAME
    "74HC574" MODEL
    LAST.BOTTOM Y L2-SPACING DOWN
    CYAN BORDER-COLOR
END

CHIP
    "ALU" NAME
    "32K EEPROM" MODEL
    LAST.BOTTOM Y L2-SPACING DOWN
    4 LEFT
    CYAN BORDER-COLOR
END

CHIP
    "Regs HI"   NAME
    "74HC670"   MODEL
    LAST.BOTTOM Y L2-SPACING SPACING2 + DOWN
    3 LEFT
    BLUE BORDER-COLOR
END

CHIP
    "Regs LO"   NAME
    "74HC670"   MODEL
    LAST.RIGHT X SPACING RIGHT
    BLUE BORDER-COLOR
END

CHIP
    "Reg Selector"  NAME
    "74HC574"       MODEL
    LAST.BOTTOM Y L2-SPACING SPACING + DOWN
    ALU.LEFT X 8 RIGHT
    MAGENTA BORDER-COLOR
END

CHIP
    "RAM Pointer"   NAME
    "74HC574"       MODEL
    LAST.LEFT X
    LAST.BOTTOM Y L2-SPACING SPACING 5 * + DOWN
    RED BORDER-COLOR
END

CHIP
    "Data RAM"  NAME
    "8K SRAM"   MODEL
    ALU.LEFT X
    LAST.BOTTOM Y L2-SPACING SPACING2 + DOWN
    255 128 0 RGB BORDER-COLOR
END

CHIP
    "X Reg"     NAME
    "74HC193"   MODEL
    RAM-POINTER.LEFT X 4 RIGHT
    LAST.BOTTOM Y L2-SPACING DOWN
    YELLOW BORDER-COLOR
END

CHIP
    "LCD"       NAME
    28 WIDTH 14 HEIGHT
    LAST.BOTTOM Y SPACING 7 * DOWN
    DATA-RAM.LEFT X
    GREEN BORDER-COLOR
END

CHIP
    "Data Bus"  NAME
    9 WIDTH 158 HEIGHT
    REGS-LO.RIGHT X SPACING 4 * RIGHT 0 Y
END

RED BORDER-COLOR

CHIP
    "PC Bits 7-4"   NAME
    "74HC193"       MODEL
    DATA-BUS.RIGHT X SPACING 4 * RIGHT
    SPACING 7 * Y
END
    
CHIP
    "PC Bits 3-0"   NAME
    "74HC193"       MODEL
    LAST.RIGHT X SPACING RIGHT
END
    
CHIP
    "Program ROM"   NAME
    "32K EEPROM"    MODEL
    PC-BITS-7-4.LEFT X 6 RIGHT
    LAST.BOTTOM L2-SPACING + Y
END

CHIP
    "PC Bits 14-12" NAME
    "74HC193"       MODEL
    PC-BITS-7-4.LEFT X
    LAST.BOTTOM Y L2-SPACING DOWN
END

CHIP
    "PC Bits 11-8"  NAME
    "74HC193"       MODEL
    LAST.RIGHT X SPACING RIGHT
END

CHIP
    "ROM Latch" NAME
    "74HC574"   MODEL
    PROGRAM-ROM.LEFT X
    PC-BITS-14-12.BOTTOM Y SPACING 5 * DOWN
    255 128 0 RGB BORDER-COLOR
END

CHIP
    "Instruction"   NAME
    "74HC574"       MODEL
    LAST.BOTTOM Y SPACING 5 * DOWN

    YELLOW BORDER-COLOR
END

CHIP
    "Output Demux"  NAME
    "74HC138"       MODEL
    LAST.BOTTOM Y L2-SPACING DOWN
    GREEN BORDER-COLOR
END

CHIP 
    "Keyboard Input"    NAME
    "74HC244"           MODEL
    LAST.BOTTOM Y L2-SPACING DOWN
    CYAN BORDER-COLOR
END

CHIP
    "Resistors"     NAME
    "10k/100k"      MODEL
    20 WIDTH 4 HEIGHT
    LAST.BOTTOM Y SPACING 3 * DOWN
    BLUE BORDER-COLOR
END

CHIP
    "Input Demux"   NAME
    "74HC138"       MODEL
    RESISTORS.BOTTOM Y SPACING2 DOWN
    MAGENTA BORDER-COLOR
END

CHIP
    "Microcode Latch"   NAME
    "74HC574"           MODEL
    INPUT-DEMUX.BOTTOM Y SPACING 8 * DOWN
    RED BORDER-COLOR
END

CHIP
    "Microcode ROM" NAME
    "8K EEPROM"       MODEL
    ;LAST.X-CENTER X 2 LEFT
    LAST.BOTTOM Y SPACING 7 * DOWN
    255 128 0 RGB BORDER-COLOR
END

CHIP
    "Microcode Count"   NAME
    "74HC193"           MODEL
    14 RIGHT
    LAST.TOP Y L2-SPACING UP 4 UP
    255 128 0 RGB BORDER-COLOR
END

;Wires
;=====
;Wire colors
0 128 0 RGB "CARRY-WIRE" DEF
0 0 144 RGB "REG-WIRE" DEF
0 128 128 RGB "ALU-WIRE" DEF
128 0 128 RGB "REG-SEL-WIRE" DEF
128 0 0 RGB "PROGRAM-ROM-WIRE" DEF
0 128 0 RGB "OUTPUT-DEMUX-WIRE" DEF
128 0 0 RGB "RAM-PTR-WIRE" DEF
128 128 0 RGB "X-REG-WIRE" DEF
128 128 0 RGB "INSTRUCTION-WIRE" DEF
128 0 128 RGB "INPUT-DEMUX-WIRE" DEF
128 0 0 RGB "MC-LATCH-WIRE" DEF
128 64 0 RGB "MC-ROM-WIRE" DEF

;Carry Buffer
WIRE
    ;Carry Buffer to ALU
    CARRY-WIRE COLOR
    CARRY-BUFFER.LEFT X
    CARRY-BUFFER.Y-CENTER Y MARK
    SPACING2 LEFT POINT
    "Q7" LABEL
    ALU.LEFT X SPACING 4 * 1 + LEFT POINT
    ALU.TOP Y 2 DOWN POINT
    ALU.LEFT X SPACING1.5 LEFT POINT
    "A8" LABEL
    ALU.LEFT X POINT

    ;Carry Buffer to Data Bus
    CARRY-BUFFER.X-CENTER X
    CARRY-BUFFER.BOTTOM Y MARK
    SPACING DOWN POINT
    "D7-D0" LABEL
    SPACING DOWN POINT
    DATA-BUS.LEFT X SPACING2 LEFT POINT
    "DB7-DB0" LABEL
    DATA-BUS.LEFT X POINT
END

;Regs LO to ALU
REG-WIRE WIRE-COLOR
WIRE
    REGS-LO.X-CENTER X REGS-LO.TOP Y MARK
    SPACING UP POINT
    "Q3-Q0" LABEL
    ALU.BOTTOM Y SPACING DOWN POINT
    "A3-A0" LABEL
    SPACING UP POINT
END

;Regs LO to Data Bus
WIRE
    REGS-LO.X-CENTER X
    REGS-LO.BOTTOM Y MARK
    SPACING DOWN POINT
    "D3-D0" LABEL
    SPACING DOWN POINT
    DATA-BUS.LEFT X SPACING2 LEFT
    "DB3-DB0" LABEL
    SPACING2 RIGHT POINT
END

;Regs LO to PC bits 11-8
WIRE
    REGS-LO.X-CENTER X
    ALU.BOTTOM Y SPACING2 SPACING + DOWN MARK
    PC-BITS-14-12.LEFT X 3 RIGHT
    RJUMP
    PC-BITS-11-8.LEFT X 4 RIGHT POINT
    PC-BITS-11-8.TOP Y SPACING UP POINT
    "D3-D0" LABEL
    SPACING DOWN POINT
END

;Regs HI to ALU
WIRE
    REGS-HI.X-CENTER X REGS-HI.TOP Y MARK
    SPACING UP POINT
    "Q3-Q0" LABEL
    ALU.BOTTOM Y SPACING DOWN POINT
    "A7-A4" LABEL
    SPACING UP POINT
END

;Regs HI to Data Bus
WIRE
    REGS-HI.X-CENTER X
    REGS-HI.BOTTOM Y MARK
    SPACING DOWN POINT
    "D3-D0" LABEL
    SPACING2 DOWN POINT
    DATA-BUS.LEFT X SPACING2 LEFT POINT
    "DB7-DB4" LABEL
    SPACING2 RIGHT POINT
END

;Regs HI to PC Bits 14-12
WIRE
    REGS-HI.X-CENTER X
    ALU.BOTTOM Y SPACING2 DOWN MARK
    REGS-LO.LEFT X 7 RIGHT POINT
    RJUMP
    PC-BITS-14-12.LEFT X 4 RIGHT POINT
    PC-BITS-14-12.TOP Y SPACING UP POINT
    "D3-D0" LABEL
    SPACING DOWN POINT
END

;ALU to ALU latch
WIRE
    ALU-WIRE COLOR
    ALU.X-CENTER X ALU.TOP Y MARK
    SPACING UP POINT
    "IO7-IO0" LABEL
    SPACING2 UP POINT
    "D7-D0" LABEL
    SPACING UP POINT
END

;ALU output to data bus
WIRE
    ALU-WIRE COLOR
    ALU-LATCH.RIGHT X 4 LEFT
    ALU-LATCH.TOP Y MARK
    SPACING UP POINT
    "Q7-Q0" LABEL
    SPACING2 UP POINT
    DATA-BUS.LEFT X SPACING2 LEFT 
    "DB7-DB0" LABEL
    SPACING2 RIGHT POINT    
END

;Reg Selector to regs
REG-SEL-WIRE WIRE-COLOR
WIRE
    ;Regs HI
    REG-SELECTOR.LEFT X 2 RIGHT
    REG-SELECTOR.TOP Y MARK
    SPACING UP POINT
    "Q3-Q2" LABEL
    REGS-HI.BOTTOM Y SPACING DOWN POINT
    "RB-RA" LABEL
    SPACING UP POINT
    ;Regs LO
    REG-SELECTOR.X-CENTER X
    REG-SELECTOR.TOP Y MARK
    SPACING UP POINT
    "Q1-Q0" LABEL
    REGS-LO.BOTTOM Y SPACING DOWN POINT
    "RB-RA" LABEL
    SPACING UP POINT
END

;Reg Selector to Data Bus
WIRE
    REG-SELECTOR.X-CENTER X
    REG-SELECTOR.BOTTOM Y MARK
    SPACING DOWN POINT
    "D3-D0" LABEL
    SPACING DOWN POINT
    DATA-BUS.LEFT X SPACING2 LEFT POINT
    "DB3-DB0" LABEL
    SPACING2 RIGHT POINT
END

;RAM Pointer to Data Bus
RAM-PTR-WIRE WIRE-COLOR
WIRE
    RAM-POINTER.RIGHT X 4 LEFT
    RAM-POINTER.BOTTOM Y MARK
    SPACING DOWN POINT
    "D7-D0" LABEL
    SPACING DOWN POINT
    DATA-BUS.LEFT X SPACING2 LEFT POINT
    "DB7-DB0" LABEL
    SPACING2 RIGHT POINT
END

;RAM Pointer to Data RAM
WIRE
    RAM-POINTER.LEFT X 4 RIGHT
    RAM-POINTER.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q7-Q0" LABEL
    DATA-RAM.TOP Y SPACING UP POINT
    "A11-A4" LABEL
    SPACING DOWN POINT
END

;RAM Pointer to LCD
WIRE
    RAM-POINTER.LEFT X
    RAM-POINTER.Y-CENTER Y MARK
    SPACING2 LEFT POINT
    "Q7-Q0" LABEL
    LCD.LEFT X SPACING 3 * LEFT POINT
    LJUMP 1 LEFT POINT
    LCD.Y-CENTER Y POINT
    1 RIGHT POINT RJUMP
    LCD.LEFT X SPACING2 LEFT POINT
    "D7-D0" LABEL
    SPACING2 RIGHT POINT
END

;Data RAM to Data Bus
WIRE
    128 64 0 RGB COLOR
    DATA-RAM.RIGHT X 4 LEFT
    DATA-RAM.BOTTOM Y MARK
    SPACING DOWN POINT
    "IO7-IO0" LABEL
    SPACING DOWN POINT
    DATA-BUS.LEFT X SPACING2 LEFT POINT
    "DB7-DB0" LABEL
    SPACING2 RIGHT POINT
END

;X Reg to Data RAM
X-REG-WIRE WIRE-COLOR
WIRE
    X-REG.LEFT X 4 RIGHT
    X-REG.TOP Y MARK
    SPACING UP POINT
    "Q3-Q0" LABEL
    DATA-RAM.BOTTOM Y SPACING DOWN POINT
    "A3-A0" LABEL
    SPACING UP POINT
END

;X Reg to Data Bus
WIRE
    X-REG.RIGHT X 2 LEFT
    X-REG.BOTTOM Y MARK
    SPACING DOWN POINT
    "A3-A0" LABEL
    SPACING DOWN POINT
    DATA-BUS.LEFT X SPACING2 LEFT POINT
    "DB3-DB0" LABEL
    SPACING2 RIGHT POINT
END

;PC to Program ROM
PROGRAM-ROM-WIRE WIRE-COLOR
WIRE
    ;PC Bits 3-0
    PC-BITS-3-0.BOTTOM Y
    PC-BITS-3-0.RIGHT X 4 LEFT MARK
    SPACING DOWN POINT
    "Q3-Q0" LABEL
    SPACING2 DOWN POINT
    "A3-A0" LABEL
    SPACING DOWN POINT

    ;PC Bits 7-4
    PC-BITS-7-4.BOTTOM Y
    PC-BITS-7-4.RIGHT X 4 LEFT MARK
    SPACING DOWN POINT
    "Q3-Q0" LABEL
    SPACING2 DOWN POINT
    "A7-A4" LABEL
    SPACING DOWN POINT
    
    ;PC Bits 11-8
    PC-BITS-11-8.TOP Y
    PC-BITS-11-8.RIGHT X SPACING2 LEFT MARK
    SPACING UP POINT
    "Q3-Q0" LABEL
    SPACING2 UP POINT
    "A11-A8" LABEL
    SPACING UP POINT

    ;PC Bits 14-12
    PC-BITS-14-12.TOP Y
    PC-BITS-14-12.RIGHT X 
    PC-BITS-14-12.WIDTH 4 / LEFT MARK 
    SPACING UP POINT
    "Q2-Q0" LABEL
    SPACING2 UP POINT
    "A14-A12" LABEL
    SPACING UP POINT
END

;PC to data bus
WIRE
    PC-BITS-7-4.RIGHT X 2 LEFT
    PC-BITS-7-4.TOP Y MARK
    SPACING UP POINT
    "D3-D0" LABEL
    SPACING UP POINT
    PC-BITS-7-4.LEFT X 3 RIGHT POINT
    LJUMP
    DATA-BUS.RIGHT X SPACING2 RIGHT POINT 
    "DB7-DB4" LABEL
    SPACING2 LEFT POINT

    PC-BITS-3-0.RIGHT X 2 LEFT
    PC-BITS-3-0.TOP Y MARK
    SPACING UP POINT
    "D3-D0" LABEL
    SPACING2 UP POINT
    PC-BITS-3-0.LEFT X 3 RIGHT POINT
    LJUMP
    PC-BITS-7-4.LEFT X 3 RIGHT POINT
    LJUMP
    DATA-BUS.RIGHT X SPACING2 RIGHT 
    "DB3-DB0" LABEL
    SPACING2 LEFT POINT
END

;Program ROM output
WIRE
    ;ROM Latch
    PROGRAM-ROM.LEFT X
    PROGRAM-ROM.Y-CENTER Y MARK
    SPACING2 LEFT POINT
    "IO7-IO0" LABEL
    DATA-BUS.RIGHT X 4 RIGHT POINT
    ROM-LATCH.Y-CENTER Y POINT
    PUSHXY
    ROM-LATCH.LEFT X SPACING2 LEFT POINT
    "D7-D0" LABEL
    SPACING2 RIGHT POINT

    ;Instruction Latch
    POPXY MARK
    INSTRUCTION.Y-CENTER Y POINT
    INSTRUCTION.LEFT X SPACING2 LEFT POINT
    "D7-D0" LABEL
    SPACING2 RIGHT POINT
END

;ROM Latch to Data Bus
WIRE
    128 64 0 RGB COLOR
    ROM-LATCH.LEFT X 4 RIGHT
    ROM-LATCH.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q7-Q0" LABEL
    SPACING DOWN POINT
    DATA-BUS.RIGHT X SPACING2 RIGHT POINT
    "DB7-DB0" LABEL
    SPACING2 LEFT POINT
END

;Instruction to Output Demux
INSTRUCTION-WIRE WIRE-COLOR
WIRE
    128 128 0 RGB COLOR
    INSTRUCTION.BOTTOM Y
    OUTPUT-DEMUX.RIGHT X 3 LEFT MARK
    SPACING DOWN POINT
    "Q2-Q0" LABEL
    SPACING2 DOWN POINT
    "A2-A0" LABEL
    SPACING DOWN POINT
END

;Instruction to Resistors
WIRE
    INSTRUCTION.LEFT X 8 RIGHT
    INSTRUCTION.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q7,Q6" LABEL
    SPACING DOWN POINT
    "Q1,Q0," LABEL
    SPACING DOWN POINT
    DATA-BUS.RIGHT X SPACING 4 * RIGHT POINT
    SPACING2 LEFT
    SPACING2 DOWN POINT
    RESISTORS.Y-CENTER Y POINT
    RESISTORS.LEFT X POINT    
END

;Instruction to ALU
WIRE
    INSTRUCTION.LEFT X 2 RIGHT
    INSTRUCTION.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q5-Q0" LABEL
    SPACING DOWN POINT
    DATA-BUS.RIGHT X SPACING 4 * RIGHT POINT
    SPACING2 UP SPACING2 LEFT POINT
    ALU.LEFT X SPACING 4 * 1 + LEFT POINT
    ALU.BOTTOM Y 2 UP POINT
    SPACING2 RIGHT POINT
    "A14-A9" LABEL
    ALU.LEFT X POINT
END

;Instruction to Input Demux
WIRE
    INSTRUCTION.RIGHT X
    INSTRUCTION.Y-CENTER Y MARK
    SPACING2 RIGHT POINT
    "Q5-Q3" LABEL
    SPACING2 RIGHT POINT
    INPUT-DEMUX.Y-CENTER Y POINT
    INPUT-DEMUX.RIGHT X SPACING2 RIGHT  POINT
    "A2-A0" LABEL
    INPUT-DEMUX.RIGHT X POINT
END

;Instruction to Microcode ROM
WIRE
    INSTRUCTION.RIGHT X 2 LEFT
    INSTRUCTION.TOP Y MARK
    SPACING UP POINT
    "Q7-Q0" LABEL
    SPACING UP POINT
    SPACING 10 * RIGHT POINT
    MICROCODE-ROM.Y-CENTER Y POINT
    MICROCODE-ROM.RIGHT X SPACING2 RIGHT POINT
    "A11-A4" LABEL
    SPACING2 LEFT POINT
END

;Output Demux signals
OUTPUT-DEMUX-WIRE WIRE-COLOR
WIRE
    ;Y0 - ALU
    OUTPUT-DEMUX.LEFT X
    OUTPUT-DEMUX.Y-CENTER Y MARK
    SPACING 3 2 / * LEFT POINT
    "Y0" LABEL
    SPACING 3 2 / * LEFT POINT
    SPACING2 DUP LEFT UP POINT
    DATA-BUS.LEFT X 4 LEFT POINT
    ALU-LATCH.Y-CENTER Y POINT
    ALU-LATCH.RIGHT X SPACING 3 2 / * RIGHT POINT
    "OE" LABEL
    ALU-LATCH.RIGHT X POINT

    ;Y1 - ROM Latch
    OUTPUT-DEMUX.RIGHT X
    OUTPUT-DEMUX.Y-CENTER Y MARK
    SPACING 3 2 / * RIGHT POINT
    "Y1" LABEL
    ROM-LATCH.RIGHT X SPACING 3 * RIGHT POINT
    ROM-LATCH.Y-CENTER Y POINT
    ROM-LATCH.RIGHT X SPACING 3 2 / * RIGHT POINT
    "OE" LABEL
    ROM-LATCH.RIGHT X POINT

    ;Y2 - RAM
    OUTPUT-DEMUX.LEFT X 4 RIGHT
    OUTPUT-DEMUX.BOTTOM Y MARK
    SPACING DOWN POINT
    "Y2" LABEL
    SPACING DOWN POINT
    DATA-RAM.RIGHT X SPACING2 LEFT POINT
    DATA-RAM.TOP Y SPACING UP POINT
    "OE" LABEL
    SPACING DOWN POINT

    ;Y3 - Keyboard Input
    OUTPUT-DEMUX.RIGHT X 4 LEFT
    OUTPUT-DEMUX.BOTTOM Y MARK
    SPACING DOWN POINT
    "Y3" LABEL
    KEYBOARD-INPUT.TOP Y SPACING UP POINT
    "OE" LABEL
    SPACING DOWN POINT
END

;Keyboard Input to Data Bus
WIRE
    0 128 128 RGB COLOR
    KEYBOARD-INPUT.X-CENTER X
    KEYBOARD-INPUT.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q7-Q0" LABEL
    SPACING DOWN POINT
    DATA-BUS.RIGHT X SPACING2 RIGHT POINT
    "DB7-DB0" LABEL
    SPACING2 LEFT POINT
END
    
;Resistors to Data Bus
WIRE
    0 0 144 RGB COLOR
    RESISTORS.X-CENTER X
    RESISTORS.BOTTOM Y MARK
    SPACING DOWN POINT
    DATA-BUS.RIGHT X SPACING 4 * RIGHT POINT
    PUSHXY
    1 UP POINT
    SPACING2 LEFT
    "DB7-DB4" LABEL
    SPACING2 LEFT POINT
    POPXY MARK
    1 DOWN POINT
    SPACING2 LEFT
    "DB3-DB0" LABEL
    SPACING2 LEFT POINT
END

;Input Demux signals
WIRE
    INPUT-DEMUX-WIRE COLOR

    ;;Y0
    ;INPUT-DEMUX.LEFT X
    ;INPUT-DEMUX.Y-CENTER Y MARK
    ;SPACING LEFT POINT
    ;"Y0" LABEL
    ;X-REG.X-CENTER X POINT
    ;X-REG.BOTTOM Y SPACING DOWN
    ;"CLOCK" LABEL
    ;SPACING UP POINT

    ;Y0
    INPUT-DEMUX.LEFT X 2 RIGHT
    INPUT-DEMUX.BOTTOM Y MARK
    SPACING DOWN POINT
    "Y0" LABEL
    SPACING DOWN POINT
    X-REG.X-CENTER X POINT
    X-REG.BOTTOM Y SPACING DOWN POINT
    "CLOCK" LABEL
    X-REG.BOTTOM Y POINT

    ;Y1
    INPUT-DEMUX.LEFT X 4 RIGHT
    INPUT-DEMUX.BOTTOM Y MARK
    SPACING DOWN POINT
    "Y1" LABEL
    SPACING2 DOWN POINT
    X-REG.LEFT X 2 RIGHT POINT
    X-REG.BOTTOM Y SPACING DOWN POINT
    "LOAD" LABEL
    X-REG.BOTTOM Y POINT

    ;Y2
    INPUT-DEMUX.RIGHT X 2 LEFT
    INPUT-DEMUX.BOTTOM Y MARK
    SPACING DOWN POINT
    "Y2" LABEL
    SPACING DOWN POINT
    PC-BITS-11-8.RIGHT X SPACING RIGHT POINT
    PC-BITS-11-8.BOTTOM Y SPACING2 DOWN POINT
    PUSHXY
    ;PC Bits 14-8
    PC-BITS-11-8.X-CENTER X POINT
    PUSHXY
    SPACING UP POINT
    "LOAD" LABEL
    PC-BITS-11-8.BOTTOM Y POINT
    POPXY MARK
    PC-BITS-14-12.X-CENTER X POINT
    SPACING UP POINT
    "LOAD" LABEL
    PC-BITS-11-8.BOTTOM Y POINT
    ;PC Bits 7-0
    POPXY MARK
    PC-BITS-3-0.TOP Y SPACING 4 * UP POINT
    PC-BITS-3-0.X-CENTER X POINT
    PUSHXY
    SPACING 3 * DOWN POINT
    "LOAD" LABEL
    PC-BITS-3-0.TOP Y POINT
    POPXY MARK
    PC-BITS-7-4.X-CENTER X POINT
    SPACING 3 * DOWN POINT
    "LOAD" LABEL
    PC-BITS-7-4.TOP Y POINT

    ;Y3
    INPUT-DEMUX.LEFT X
    INPUT-DEMUX.Y-CENTER Y MARK
    SPACING1.5 LEFT POINT
    "Y3" LABEL
    SPACING1.5 LEFT POINT
    DATA-BUS.LEFT X SPACING2 LEFT POINT
    RAM-POINTER.Y-CENTER Y POINT
    RAM-POINTER.RIGHT X SPACING2 RIGHT POINT
    "LOAD" LABEL
    DATA-RAM.RIGHT X POINT

    ;Y4
    INPUT-DEMUX.LEFT X 6 RIGHT
    INPUT-DEMUX.BOTTOM Y MARK
    SPACING DOWN POINT
    "Y4" LABEL
    SPACING2 SPACING + DOWN POINT
    DATA-RAM.LEFT X 4 RIGHT POINT
    DATA-RAM.BOTTOM Y SPACING DOWN POINT
    "LOAD" LABEL
    SPACING UP POINT
     
    ;Y5
    INPUT-DEMUX.LEFT X 10 RIGHT
    INPUT-DEMUX.BOTTOM Y MARK
    SPACING DOWN POINT
    "Y5" LABEL
    SPACING 5 * DOWN POINT
    DATA-BUS.LEFT X SPACING2 LEFT POINT
    LCD.Y-CENTER Y POINT
    LCD.RIGHT X SPACING2 RIGHT POINT
    "LOAD" LABEL
    SPACING2 LEFT POINT

    ;Y6
    INPUT-DEMUX.LEFT X 8 RIGHT
    INPUT-DEMUX.BOTTOM Y MARK
    SPACING DOWN POINT
    "Y6" LABEL
    SPACING 4 * DOWN POINT
    REGS-HI.LEFT X 2 LEFT POINT
    CARRY-BUFFER.BOTTOM Y SPACING2 DOWN POINT
    CARRY-BUFFER.LEFT X 4 RIGHT POINT
    SPACING UP POINT
    "LOAD" LABEL
    SPACING UP POINT
END

;Microcode latch signals
WIRE
    MC-LATCH-WIRE COLOR

    ;Q0
    MICROCODE-LATCH.RIGHT X 6 LEFT
    MICROCODE-LATCH.TOP Y MARK
    SPACING UP POINT
    "Q0" LABEL
    INPUT-DEMUX.BOTTOM Y SPACING 3 * DOWN POINT
    11 RIGHT POINT
    RJUMP
    PROGRAM-ROM.RIGHT X 4 RIGHT POINT
    PC-BITS-11-8.BOTTOM Y 8 DOWN POINT
    PUSHXY
    PC-BITS-11-8.LEFT X 2 RIGHT POINT
    PUSHXY
    PC-BITS-11-8.BOTTOM Y SPACING DOWN POINT
    "CLOCK" LABEL
    SPACING UP POINT
    POPXY MARK
    PC-BITS-14-12.LEFT X 2 RIGHT POINT
    PC-BITS-14-12.BOTTOM Y SPACING DOWN POINT
    "CLOCK" LABEL
    SPACING UP POINT
    POPXY MARK
    PC-BITS-3-0.TOP Y SPACING 5 * UP POINT
    PC-BITS-3-0.LEFT X 2 RIGHT POINT
    PUSHXY
    PC-BITS-3-0.TOP Y SPACING UP POINT
    "CLOCK" LABEL
    SPACING DOWN POINT
    POPXY MARK
    PC-BITS-7-4.LEFT X 2 RIGHT POINT
    PC-BITS-7-4.TOP Y SPACING UP POINT
    "CLOCK" LABEL
    SPACING DOWN POINT
    
    ;Q1
    MICROCODE-LATCH.RIGHT X 4 LEFT
    MICROCODE-LATCH.TOP Y MARK
    SPACING UP POINT
    "Q1" LABEL
    INPUT-DEMUX.BOTTOM Y SPACING 4 * DOWN POINT
    9 RIGHT RJUMP
    PROGRAM-ROM.RIGHT X SPACING 3 * RIGHT POINT
    PC-BITS-11-8.BOTTOM Y SPACING 3 * DOWN POINT
    PUSHXY
    1 LEFT LJUMP
    PC-BITS-11-8.RIGHT X 4 LEFT POINT
    PUSHXY
    PC-BITS-11-8.BOTTOM Y SPACING DOWN POINT
    "OE" LABEL
    SPACING UP POINT
    POPXY MARK
    9 LEFT LJUMP
    PC-BITS-14-12.RIGHT X 4 LEFT POINT
    PC-BITS-14-12.BOTTOM Y SPACING DOWN POINT
    "OE" LABEL
    SPACING UP POINT
    POPXY MARK
    PC-BITS-3-0.BOTTOM Y SPACING2 DOWN POINT
    1 LEFT LJUMP
    PC-BITS-3-0.RIGHT X 3 LEFT
    LJUMP
    PC-BITS-3-0.LEFT X 4 RIGHT POINT
    PUSHXY
    SPACING UP POINT
    "OE" LABEL
    SPACING UP POINT
    POPXY MARK
    PC-BITS-7-4.RIGHT X 3 LEFT POINT
    LJUMP
    PC-BITS-7-4.LEFT X 4 RIGHT POINT
    SPACING UP POINT
    "OE" LABEL
    SPACING UP POINT
    
    ;Q2
    MICROCODE-LATCH.LEFT X 2 RIGHT
    MICROCODE-LATCH.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q2" LABEL
    LCD.BOTTOM Y SPACING DOWN POINT
    ALU-LATCH.LEFT X SPACING 5 * 1 + LEFT POINT
    ALU-LATCH.Y-CENTER Y POINT
    ALU-LATCH.LEFT X SPACING2 LEFT POINT
    "LOAD" LABEL
    ALU-LATCH.LEFT X POINT

    ;Q3
    MICROCODE-LATCH.RIGHT X 2 LEFT 
    MICROCODE-LATCH.TOP Y MARK
    SPACING UP POINT
    "Q3" LABEL
    INPUT-DEMUX.BOTTOM Y SPACING 5 * DOWN POINT
    7 RIGHT RJUMP
    ROM-LATCH.RIGHT X SPACING 8 * RIGHT POINT
    ROM-LATCH.BOTTOM Y SPACING2 DOWN POINT
    1 LEFT LJUMP LJUMP
    ROM-LATCH.RIGHT X 4 LEFT POINT
    SPACING UP POINT
    "LOAD" LABEL
    SPACING UP POINT

    ;Q4
    INPUT-DEMUX.RIGHT X 4 LEFT
    MICROCODE-LATCH.TOP Y MARK
    SPACING UP POINT
    "Q4" LABEL
    INPUT-DEMUX.BOTTOM Y SPACING DOWN POINT
    "E" LABEL
    SPACING UP POINT

    ;Q5
    MICROCODE-LATCH.RIGHT X
    MICROCODE-LATCH.Y-CENTER Y MARK
    SPACING1.5 RIGHT POINT
    "Q5" LABEL
    SPACING1.5 RIGHT POINT
    SPACING UP POINT
    OUTPUT-DEMUX.BOTTOM Y POINT
    INSTRUCTION.BOTTOM Y SPACING2 DOWN ;POINT
    INSTRUCTION.RIGHT X 2 LEFT POINT
    SPACING UP POINT
    "LOAD" LABEL
    SPACING UP POINT

    ;Q6
    MICROCODE-LATCH.LEFT X 6 RIGHT
    MICROCODE-LATCH.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q6" LABEL
    LCD.BOTTOM Y SPACING2 SPACING + DOWN POINT
    REGS-HI.LEFT X SPACING 5 * LEFT POINT
    REGS-LO.TOP Y SPACING2 SPACING + UP POINT
    5 RIGHT RJUMP
    REGS-LO.LEFT X 2 RIGHT POINT
    SPACING2 DOWN POINT
    "LOAD" LABEL
    SPACING DOWN POINT

    ;Q7
    MICROCODE-LATCH.LEFT X 4 RIGHT
    MICROCODE-LATCH.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q7" LABEL
    LCD.BOTTOM Y SPACING2 DOWN POINT
    REGS-HI.LEFT X SPACING 4 * LEFT POINT
    REGS-HI.TOP Y SPACING2 UP POINT
    3 RIGHT RJUMP
    REGS-HI.LEFT X 2 RIGHT POINT
    SPACING DOWN POINT
    "LOAD" LABEL
    SPACING DOWN POINT
END

;Microcode ROM
WIRE
    MC-ROM-WIRE COLOR
    
    ;Microcode ROM
    MICROCODE-ROM.LEFT X 10 RIGHT
    MICROCODE-ROM.TOP Y MARK
    SPACING UP POINT
    "IO7-IO0" LABEL
    MICROCODE-LATCH.BOTTOM Y SPACING DOWN POINT
    "D7-D0" LABEL
    SPACING UP POINT

    ;Microcode Counter
    MICROCODE-COUNT.X-CENTER X
    MICROCODE-COUNT.BOTTOM Y MARK
    SPACING DOWN POINT
    "Q3-Q0" LABEL
    MICROCODE-ROM.TOP Y SPACING UP POINT
    "A3-A0" LABEL
    SPACING DOWN POINT
END
